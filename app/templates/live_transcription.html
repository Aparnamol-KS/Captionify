{% extends "base.html" %}
{% include 'navbar.html' %}

{% block style %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Merriweather', serif;
    }

    body {
        background-color: #0B0C10;

    }

    .header {
        text-align: center;
        margin-top: 70px;
    }

    .header h1 {
        margin-top: 15px;
        font-size: 3rem;
        text-align: center;
        font-family: fantasy;
        color: #66FCF1;
        font-weight: lighter;
    }

    .transcription-box {
        width: 100%;
        height: 65vh;
        background-color: #1a1c22;
        padding: 20px;
        font-size: 1.17rem;
        overflow-y: auto;
        box-shadow: 0px 4px 8px rgba(53, 44, 44, 0.664);
        border-radius: 10px;
        color: #EBE9E1;
        margin: 20px;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .transcription-box::-webkit-scrollbar {
        display: none;
    }


    .button {
        background-color: #0B0C10;
        border: 2px solid #66FCF1;
        color: white;
        padding: 15px;
        font-size: 25px;
        text-align: center;
        cursor: pointer;
        border-radius: 8px;
        margin: 0 10px;
        box-shadow: 0px 4px 6px rgba(232, 228, 228, 0.689);
        transition: all 0.3s ease;
        width: 100%;
    }

    .button:hover {
        transform: scale(1.05);
    }

    /* Disabled button style */
    .button:disabled {
        background-color: #4A4A4A;
        border: 2px solid #A9A9A9;
        color: #B0B0B0;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .alert-container {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        /* Ensure it's above all other elements */
        width: 100%;
    }

    /* Blur background when modal is shown */
    body.modal-open .main-content {
        filter: blur(5px);
    }

    /* Optional dark overlay */
    .modal-backdrop.show {
        opacity: 0.5;
    }
</style>
{% endblock style %}

{% block content %}
<div class="alert-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>
<div class="header">
    <h1>LIVE TRANSCRIPTION</h1>
</div>

<!-- Transcription Box -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="transcription-box" id="transcription" aria-live="polite" contenteditable="false">

            </div>
        </div>
    </div>


    <!-- Form for summarization and buttons -->
    <div class="row justify-content-center mt-3">


        <div class="row justify-content-center w-100 text-center">
            <!-- Start Recording -->
            <div class="col-md-1 col-6 mb-2">
                <button class="button w-100" title="Start recording!" id="start-btn" onclick="startRecording()"><i
                        id="rec-start" class="fa-solid fa-microphone"></i></button>
            </div>

            <!-- Stop Recording -->
            <div class="col-md-1 col-6 mb-2">
                <button class="button w-100" title="Stop recording!" id="stop-btn" onclick="stopRecording()"><i
                        class="fa-solid fa-stop"></i></button>
            </div>

            <!-- Save as PDF -->
            <div class="col-md-1 col-6 mb-2">
                <form action="{{ url_for('main.save_pdf') }}" method="post" onsubmit="prepareTranscription()"
                    class="w-100">
                    <input type="hidden" id="transcription_text" name="transcription_text">
                    <button id = "save-pdf-btn" type="submit" title="Save as PDF" class="button w-100"><i
                            class="fa-solid fa-file-pdf"></i></button>
                </form>
            </div>

            <!-- Summarize -->
            <div class="col-md-1 col-6 mb-2">
                <form action="{{ url_for('main.summary') }}" method="post" class="w-100" onsubmit="prepareTranscriptionForSummarize()" >
                    <input type="hidden" name="caption_name" id="userNameInput-caption">
                    <input type="hidden" name="transcript" id="transcript-input">
                    <button id="summary-btn" type="submit" title="Summarize!" class="button w-100"><i
                            class="fa-solid fa-book"></i></button>
                </form>
            </div>

            <!-- Clear -->
            <div class="col-md-1 col-6 mb-2">
                <button id="clear-btn" title="clear" class="button w-100"><i class="fa-solid fa-eraser"></i></button>
            </div>

            <div class="col-md-1 col-6 mb-2">
                <button type="button" id="edit-btn" title="Edit Transcription" class="button w-100"
                    onclick="toggleEdit()"><i id="editIcon" class="fa-solid fa-pen-to-square"></i></button>
            </div>

            <div class="col-md-1 col-6 mb-2">
                <input type="hidden" id="transcription_text_save" name="transcription_text_save">
                <button type="submit" id="save-btn" onclick="showInputBox(), prepareTranscriptionForSave()"
                    title="Save to refer later" class="button w-100"><i
                        class="fa-solid fa-cloud-arrow-up"></i></i></button>
            </div>

        </div>


    </div>
</div>


<div class="modal fade" id="inputModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="saveForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Caption Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="userNameInput" name="caption_name" class="form-control"
                        placeholder="Your Name" required />
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    var socket = io();

    // Receive live transcription from server and update UI
    socket.on('transcription', function (data) {
        let transcriptionBox = document.getElementById("transcription");
        transcriptionBox.innerText += " " + data;
        transcriptionBox.scrollTop = transcriptionBox.scrollHeight; // Auto-scroll to bottom
        updateButtonState();
    });
    window.onload = function () {
        updateButtonState();
    };

    function startRecording() {
        fetch('/live_transcription/start_recording')
            .then(response => response.json())
            .then(data => {
                console.log("Recording started:", data);
                console.log("Recording started:", data);
                let startBtn = document.getElementById("start-btn");
                startBtn.disabled = true;
                startBtn.style.backgroundColor = "red";
                startBtn.style.color = "white";
                document.getElementById("stop-btn").disabled = false;
                document.getElementById("clear-btn").disabled = true;
                document.getElementById("edit-btn").disabled = true;
                document.getElementById("summary-btn").disabled = true;
                document.getElementById('save-pdf-btn').disabled = true;
            })
            .catch(error => console.error("Error starting recording:", error));
    }


    function stopRecording() {
        fetch('/live_transcription/stop_recording')
            .then(response => response.json())
            .then(data => {
                let startBtn = document.getElementById("start-btn");
                startBtn.disabled = false;

                startBtn.style.backgroundColor = "";
                startBtn.style.color = "";
                document.getElementById("stop-btn").disabled = true;
                document.getElementById("clear-btn").disabled = false;
                document.getElementById("edit-btn").disabled = false;
                document.getElementById("summary-btn").disabled = false;
                document.getElementById('save-pdf-btn').disabled = false;
            })
            .catch(error => console.error("Error stopping recording:", error));
    }


    function prepareTranscription() {
        document.getElementById("transcription_text").value =
            document.getElementById("transcription").innerText.trim();
    }

    document.getElementById("clear-btn").addEventListener("click", function () {
        document.getElementById("transcription").innerText = ""; // Clears the div content
        updateButtonState();
    });

    function toggleEdit() {
        let transcriptionBox = document.getElementById("transcription");

        let icon = document.getElementById("editIcon");

        if (transcriptionBox.contentEditable === "true") {
            transcriptionBox.contentEditable = "false";
            icon.className = "fa-solid fa-pen-to-square";
            icon.title = "Edit Transcription"
            prepareTranscriptionForSave()

            const name = document.getElementById('userNameInput').value;
            const content = document.getElementById('transcription_text_save').value;

            // Prepare form data to send both inputs
            const formData = new FormData();
            formData.append('caption_name', name);
            formData.append('content', content);

            fetch('/live_transcription/save_to_db', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success edit:', data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });

        } else {
            transcriptionBox.contentEditable = "true";
            transcriptionBox.focus();
            icon.className = "fa-regular fa-floppy-disk";
            icon.title = "Save edit"
        }

    }

    function prepareTranscriptionForSummarize() {
        document.getElementById("transcript-input").value = document.getElementById("transcription").innerText;
        document.getElementById("userNameInput-caption").value = document.getElementById('userNameInput').value;

    }

    function prepareTranscriptionForSave() {
        document.getElementById("transcription_text_save").value = document.getElementById("transcription").innerText;
    }

    function updateButtonState() {
        let transcriptionText = document.getElementById("transcription").innerText.trim();

        let clearBtn = document.getElementById("clear-btn");
        let editBtn = document.getElementById("edit-btn");

        clearBtn.disabled = transcriptionText === "";
        editBtn.disabled = transcriptionText === "";
    }






    const modalEl = new bootstrap.Modal(document.getElementById('inputModal'));
    function showInputBox() {
        modalEl.show();
        setTimeout(() => {
            document.getElementById('userNameInput').focus();
        }, 200);
    }


    document.getElementById('saveForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const name = document.getElementById('userNameInput').value;
        const content = document.getElementById('transcription_text_save').value;

        // Prepare form data to send both inputs
        const formData = new FormData();
        formData.append('caption_name', name);
        formData.append('content', content);

        fetch('/live_transcription/save_to_db', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                modalEl.hide();
                // Optionally clear input fields or show success message
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });


    // Automatically hide alerts after 5 seconds
    setTimeout(function () {
        let alerts = document.querySelectorAll(".alert");
        alerts.forEach(alert => {
            let bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 3000);
</script>
{% endblock content %}